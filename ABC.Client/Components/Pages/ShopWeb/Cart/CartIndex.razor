@using ABC.Shared.Models
@using ABC.Shared.Models.ViewModels
@page "/CartIndex"

@rendermode InteractiveServer

<PageTitle>ABC - Shopping Cart</PageTitle>

<section class="container mt-3 mb-3 FooterminHeight">
	<div class="row pt-2 pb-4" id="topbar">
		<!-- Title -->
		<div class="col-lg-8  text-start mb-3 mb-sm-0">
			<h1 class="text">Shopping Cart</h1>
		</div>
	</div>

	<div>
		@if (shoppingCartList != null && shoppingCartList.Any())
		{
			double totalAmount = 0.00;
			@foreach (var item in shoppingCartList)
			{
				var updateFormId = $"updateForm{item.Id}";
				var updateModalId = $"updateItem{item.Id}";

				var removeFormId = $"removeForm{item.Id}";
				var removeModalId = $"removeItem{item.Id}";
				
				<section class="row border-bottom pb-3">
					<div class="d-none d-lg-block col-lg-1 text-center py-2">
						<img src="@item.Product.ImageUrl" class="rounded" width="100%" />
					</div>

					<div class="col-12 col-lg-6 pt-md-3">
						<h3 class="text-uppercase"><strong>@item.Product.productName</strong></h3>
						<p><b>Php @item.Product.RetailPrice</b></p>
					</div>

					<div class="col-12 col-lg-5 text-center row">
						@* <div class="col-4 text-md-right pt-2 pt-md-4">
							<EditForm method="post" FormName="@updateFormId" id="@updateFormId" Model="ShoppingCartToUpdate" OnValidSubmit="() => UpdateShoppingCart(item)">
								<h5 class="fw-semibold">
									<div class="input-group quantity-input">
										<button class="btn btn-outline-secondary" type="button"><i class="bi bi-dash-lg"></i></button>
										<InputNumber @bind-Value="item.Quantity" oninput="UpdateShoppingCart" class="form-control quantity" id="@item.Id"></InputNumber>
										<button class="btn btn-outline-secondary" type="submit"><i class="bi bi-plus-lg"></i></button>
									</div>
								</h5>
							</EditForm>
						</div> *@

						<div class="col-6 text-md-right pt-2 pt-md-4">
							<h5 class="fw-semibold">
								Quantity: @item.Quantity
							</h5>
						</div>

						<div class="col-6 col-sm-4 col-lg-6 pt-2 d-flex flex-row justify-content-end">
							<div class="col-3">
								<EditForm method="post" FormName="@updateFormId" id="@updateFormId" Model="ShoppingCartToUpdate" OnValidSubmit="() => UpdateShoppingCart(item)">
									<button class="btn btn-primary" type="button" title="Update Item" id="@item.Id" data-bs-toggle="modal" data-bs-target="#@updateModalId">
										<i class="bi bi-pencil-square"></i>
									</button>

									<!-- Update cartItem Modal -->
									<div class="modal fade" id="@updateModalId" tabindex="-1" aria-labelledby="removeItemLabel" aria-hidden="true">
										<div class="modal-dialog modal-sm modal-dialog-centered">
											<div class="modal-content">
												<div class="modal-header">
													<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body p-0">
													<div class="modal-body">
														<div>
															@item.ProductName

														</div>

														<div class="form-group" id="quantityInputDiv">
															<label for="quantity">Quantity:</label>
															<InputNumber @bind-Value="NewQuantity" id="quantity" class="form-control pt-3">@item.Quantity</InputNumber>
														</div>
													</div>
												</div>
												<div class="modal-footer d-flex justify-content-center border p-0">
													<button type="button" class="btn text-center col border-end" data-bs-dismiss="modal">Cancel</button>
													<button type="submit" class="btn text-center col" data-bs-dismiss="modal">Confirm</button>
												</div>
											</div>
										</div>
									</div>
								</EditForm>
							</div>
							<div class="col-3">
								<EditForm Enhance="false" method="post" FormName="@removeFormId" id="@removeFormId" Model="ProductIdToRemove" OnValidSubmit="() => RemoveShoppingCart(item.Id)">
									<button class="btn btn-danger" type="button" title="Remove Item" id="@item.Id" data-bs-toggle="modal" data-bs-target="#@removeModalId">
										<i class="bi bi-x-square"></i>
									</button>

									<!-- Remove cartItem Modal -->
									<div class="modal fade" id="@removeModalId" tabindex="-1" aria-labelledby="removeItemLabel" aria-hidden="true">
										<div class="modal-dialog modal-sm modal-dialog-centered">
											<div class="modal-content">
												<div class="modal-header">
													<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body p-0">
													<div class="modal-body">
														<div class="text-center">
															Remove the item?
														</div>
													</div>
												</div>
												<div class="modal-footer d-flex justify-content-center border p-0">
													<button type="button" class="btn text-center col border-end" data-bs-dismiss="modal">Cancel</button>
													<button type="submit" class="btn text-center col" data-bs-dismiss="modal">Confirm</button>
												</div>
											</div>
										</div>
									</div>
								</EditForm>
							</div>
						</div>
					</div>
				</section>

				totalAmount += item.Product.RetailPrice * item.Quantity;
				
			}

			@if (shoppingCartList.Count > 0)
			{
				<div class="row container border-1 mx-auto my-5">
					<div class="col-9">
						<h2>Total: <b>Php @totalAmount</b></h2>
					</div>
					<div class="col-3">
						<button type="submit" class="btn btn-success bg-gradient w-100 py-2 text-uppercase fw-semibold">
							Checkout
						</button>
					</div>
				</div>
			}

		} else
		{
			<div class="fs-3 fw-bold text-center"><i class="bi bi-cart2"></i> Empty cart.</div>

			<div class="row container border-dark mx-auto my-5">
				<div class="col-9">
					<h2>Total: <b>Php 0.00</b></h2>
				</div>
				<div class="col-3">
					<button type="submit" class="btn btn-success bg-gradient w-100 py-2 text-uppercase fw-semibold" disabled>
						Checkout
					</button>
				</div>
			</div>
		}

	</div>
</section>

<script>
	@* PREVENTS FORM RESUBMISSION ON REFRESH *@
	if (window.history.replaceState) {
		window.history.replaceState(null, null, window.location.href);
	}
</script>
